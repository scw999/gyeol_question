<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결하다 주관적 선호 설문</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .question-card {
            transition: all 0.3s ease-in-out;
        }
        .result-bar {
            transition: width 1s ease-in-out;
        }
        .expectation-q {
            border-left: 4px solid #14b8a6; /* teal-500 */
            background-color: #f0fdfa; /* teal-50 */
        }
        .self-q {
             border-left: 4px solid #6366f1; /* indigo-500 */
            background-color: #eef2ff; /* indigo-50 */
        }
        /* Custom styles for range input */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 7.3px 0;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 11.4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 26px;
            width: 26px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7.3px;
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: #d1d5db;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 11.4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 5px;
        }
        input[type=range]::-moz-range-thumb {
            height: 26px;
            width: 26px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">결하다</h1>
            <p class="text-lg md:text-xl text-gray-600 mt-2">주관적 선호 설문 (v9: 최종 통합본)</p>
        </header>

        <!-- Input Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Male Form -->
            <div class="bg-blue-50 p-6 rounded-2xl shadow-md border border-blue-200">
                <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">👨‍🦱 남성</h2>
                <form id="male-form" class="space-y-8">
                    <!-- Questions will be dynamically inserted here -->
                </form>
            </div>

            <!-- Female Form -->
            <div class="bg-pink-50 p-6 rounded-2xl shadow-md border border-pink-200">
                <h2 class="text-2xl font-bold text-center mb-6 text-pink-800">👩‍🦰 여성</h2>
                <form id="female-form" class="space-y-8">
                    <!-- Questions will be dynamically inserted here -->
                </form>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mt-8 md:mt-12">
            <button id="view-result-btn" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-full text-xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                궁합 결과 보기
            </button>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div id="result-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 md:p-8 relative transform scale-95 transition-transform duration-300">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-indigo-600">관계 궁합 리포트</h2>
                </div>

                <!-- Overall Score -->
                <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-6 text-center mb-8">
                    <p class="text-lg text-indigo-800 mb-2">두 분의 종합 궁합 지수는?</p>
                    <p id="overall-score" class="text-7xl font-extrabold text-indigo-600">0점</p>
                    <p id="overall-comment" class="mt-3 text-base text-indigo-700 font-medium"></p>
                </div>

                <!-- Detailed Scores -->
                <div class="space-y-6" id="detailed-results-container">
                    <!-- Detailed results will be inserted here -->
                </div>

                <!-- Ice Breaking Questions -->
                 <div class="mt-10 pt-6 border-t-2 border-gray-200">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">대화를 시작해보세요! 💬</h3>
                    <div id="ice-breaking-questions" class="space-y-5">
                        <!-- Ice breakers will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            // Part 1: 가치관
            { id: 'q1_self', part: "Part 1: 삶의 나침반 (가치관)", q_type: 'self', text: "1억 원의 보너스가 생겼습니다. 당신의 선택은?", type: "select", options: [{ value: "a", text: "즉시 평소 꿈꾸던 차를 계약한다 (현재의 만족)" }, { value: "b", text: "안정적인 우량주에 장기 투자한다 (미래의 안정)" }, { value: "c", text: "부모님께 절반을 드리고 나머지는 저축한다 (가족과 관계)" }, { value: "d", text: "MBA 진학 등 커리어 발전을 위해 사용한다 (성장과 성취)" }] },
            { id: 'q1_exp', part: "Part 1: 삶의 나침반 (가치관)", q_type: 'expectation', text: "파트너가 1억 보너스를 받았을 때, 어떻게 사용하길 바라나요?", type: "select", options: [{ value: "a", text: "즉시 평소 꿈꾸던 차를 계약한다 (현재의 만족)" }, { value: "b", text: "안정적인 우량주에 장기 투자한다 (미래의 안정)" }, { value: "c", text: "부모님께 절반을 드리고 나머지는 저축한다 (가족과 관계)" }, { value: "d", text: "MBA 진학 등 커리어 발전을 위해 사용한다 (성장과 성취)" }] },
            { id: 'q_child_plan_self', part: "Part 1: 삶의 나침반 (가치관)", q_type: 'self', text: "자녀 계획에 대한 당신의 생각은 어떤가요?", type: "select", options: [{ value: "a", text: "꼭 낳고 싶다 (자녀는 삶의 기쁨)" }, { value: "b", text: "상대방과 합의된다면 낳고 싶다 (관계 중심)" }, { value: "c", text: "딩크(DINK)를 선호한다 (개인의 삶 중시)" }, { value: "d", text: "아직 잘 모르겠다 (미정)"}] },
            { id: 'q_m1_self', part: "Part 1: 삶의 나침반 (가치관)", for_gender: 'male', q_type: 'self', text: "연인이 당신의 소득이나 직업 안정성에 대해 불안감을 내비친다면, 당신의 반응은?", type: "select", options: [{ value: "a", text: "불안함을 공감하며, 함께 미래 계획을 세운다" }, { value: "b", text: "내 능력을 믿어주지 않는 것 같아 서운하다" }, { value: "c", text: "더 안정적인 직장을 알아봐야 하나 고민한다" }] },
            { id: 'q_m1_exp', part: "Part 1: 삶의 나침반 (가치관)", for_gender: 'female', q_type: 'expectation', text: "파트너가 그의 소득/직업에 대한 당신의 불안감에 어떻게 반응해주길 바라나요?", type: "select", options: [{ value: "a", text: "불안함을 공감하며, 함께 미래 계획을 세운다" }, { value: "b", text: "내 능력을 믿어주지 않는 것 같아 서운하다" }, { value: "c", text: "더 안정적인 직장을 알아봐야 하나 고민한다" }] },
            { id: 'q_f1_self', part: "Part 1: 삶의 나침반 (가치관)", for_gender: 'female', q_type: 'self', text: "결혼/출산으로 커리어가 중단될 수 있는 가능성에 대해 어떻게 생각하시나요?", type: "select", options: [{ value: "a", text: "커리어보다 가정이 중요하므로, 감수할 수 있다" }, { value: "b", text: "경력 단절은 안된다. 파트너와 함께 해결책을 찾을 것이다" }, { value: "c", text: "커리어를 위해 결혼/출산을 미루거나 포기할 수 있다" }] },
            { id: 'q_f1_exp', part: "Part 1: 삶의 나침반 (가치관)", for_gender: 'male', q_type: 'expectation', text: "파트너가 결혼/출산으로 인한 커리어 중단 가능성에 대해 어떻게 생각하길 바라나요?", type: "select", options: [{ value: "a", text: "커리어보다 가정이 중요하므로, 감수할 수 있다" }, { value: "b", text: "경력 단절은 안된다. 파트너와 함께 해결책을 찾을 것이다" }, { value: "c", text: "커리어를 위해 결혼/출산을 미루거나 포기할 수 있다" }] },
            
            // Part 2: 성격/기질
            { id: 'q5_self', part: "Part 2: 타고난 다름 (성격/기질)", q_type: 'self', text: "연인과 갈등이 생겼을 때, 당신의 일반적인 반응은?", type: "select", options: [{ value: "a", text: "감정이 격해지더라도 그 자리에서 바로 대화로 풀어야 한다 (즉시 해결형)" }, { value: "b", text: "일단 각자 생각할 시간을 갖고, 감정이 가라앉으면 대화한다 (숙고 후 해결형)" }, { value: "c", "text": "상대방의 기분이 풀릴 때까지 일단 맞춰주고, 나중에 다시 이야기한다 (화합 우선형)" }, { value: "d", text: "문제를 직접적으로 언급하기보다, 시간이 해결해주길 기다린다 (회피형)" }] },
            { id: 'q5_exp', part: "Part 2: 타고난 다름 (성격/기질)", q_type: 'expectation', text: "연인이 갈등 상황에서 어떻게 반응해주길 바라나요?", type: "select", options: [{ value: "a", text: "감정이 격해지더라도 그 자리에서 바로 대화로 풀어야 한다 (즉시 해결형)" }, { value: "b", text: "일단 각자 생각할 시간을 갖고, 감정이 가라앉으면 대화한다 (숙고 후 해결형)" }, { value: "c", "text": "상대방의 기분이 풀릴 때까지 일단 맞춰주고, 나중에 다시 이야기한다 (화합 우선형)" }, { value: "d", text: "문제를 직접적으로 언급하기보다, 시간이 해결해주길 기다린다 (회피형)" }] },
            
            // Part 3: 라이프스타일
            { id: 'q7_self', part: "Part 3: 일상의 합 (라이프스타일)", q_type: 'self', text: "꿈에 그리던 완벽한 토요일, 당신의 하루는 어떤 모습에 가장 가까운가요?", type: "select", options: [{ value: "a", text: "하루 종일 침대와 한 몸! 넷플릭스와 배달 음식과 함께하는 완전한 방콕 (완전한 휴식)" }, { value: "b", text: "아침 일찍 등산 후, 맛있는 막걸리와 파전으로 마무리 (아웃도어/활동)" }, { value: "c", text: "미술관에서 영감을 얻고, 저녁엔 분위기 좋은 재즈바에서 칵테일 한 잔 (문화/예술)" }, { value: "d", text: "친구들과 만나 브런치를 즐기고, 저녁엔 새로운 사람들과 어울리는 파티 참석 (사교/네트워킹)" }, { value: "e", text: "대청소로 집을 반짝이게 만들고, 정성껏 요리해서 소중한 사람과 저녁 식사 (자기관리/안정)" }, { value: "f", text: "땀 흘리는 운동(헬스, 필라테스) 후 마시는 시원한 단백질 쉐이크 (스포츠/건강)" }, { value: "g", text: "친구들과 모여 보드게임을 하며 밤새 웃고 떠들기 (실내/사교)" }, { value: "h", text: "평소 배우고 싶었던 베이킹 등 원데이 클래스 참여하기 (자기계발/취미)" }, { value: "i", text: "반려동물과 함께 애견 카페나 넓은 공원에서 시간 보내기 (반려동물/교감)" }] },
            { id: 'q_dessert_self', part: "Part 3: 일상의 합 (라이프스타일)", q_type: 'self', text: "가장 좋아하는 디저트 스타일은 무엇인가요?", type: "select", options: [{ value: "a", text: "케이크, 마카롱 등 달콤한 서양식 디저트" }, { value: "b", text: "빙수, 아이스크림 등 시원한 디저트" }, { value: "c", text: "약과, 떡, 팥빙수 등 K-디저트" }, { value: "d", text: "디저트는 별로... (해당 없음)" }] },
            { id: 'q_m2_self', part: "Part 3: 일상의 합 (라이프스타일)", for_gender: 'male', q_type: 'self', text: "개인 취미(게임, 낚시 등)에 주말 시간을 온전히 사용하는 것에 대해 연인이 서운해한다면?", type: "select", options: [{ value: "a", text: "연인과의 시간이 더 중요하므로, 취미를 줄인다" }, { value: "b", text: "서운함을 풀어주고, 취미의 중요성을 설명하며 타협점을 찾는다" }, { value: "c", text: "개인의 시간은 존중받아야 한다고 주장한다" }] },
            { id: 'q_m2_exp', part: "Part 3: 일상의 합 (라이프스타일)", for_gender: 'female', q_type: 'expectation', text: "파트너가 개인 취미로 주말을 보낼 때, 당신이 서운함을 느낀다면 어떻게 행동해주길 바라나요?", type: "select", options: [{ value: "a", text: "연인과의 시간이 더 중요하므로, 취미를 줄인다" }, { value: "b", text: "서운함을 풀어주고, 취미의 중요성을 설명하며 타협점을 찾는다" }, { value: "c", text: "개인의 시간은 존중받아야 한다고 주장한다" }] },
            { id: 'q_f2_self', part: "Part 3: 일상의 합 (라이프스타일)", for_gender: 'female', q_type: 'self', text: "맞벌이를 할 경우, 가사 분담의 가장 이상적인 모습은?", type: "select", options: [{ value: "a", text: "시간 여유가 있는 사람이 더 많이 한다" }, { value: "b", text: "각자 잘하는 일을 분담해서 처리한다" }, { value: "c", text: "5:5로 공평하게, 또는 규칙을 정해서 분담한다" }] },
            { id: 'q_f2_exp', part: "Part 3: 일상의 합 (라이프스타일)", for_gender: 'male', q_type: 'expectation', text: "맞벌이를 할 경우, 파트너가 어떤 가사 분담 방식을 선호하길 바라나요?", type: "select", options: [{ value: "a", text: "시간 여유가 있는 사람이 더 많이 한다" }, { value: "b", text: "각자 잘하는 일을 분담해서 처리한다" }, { value: "c", text: "5:5로 공평하게, 또는 규칙을 정해서 분담한다" }] },

            // Part 4: 관계의 기술
            { id: 'q10_self', part: "Part 4: 관계의 기술 (소통/관계)", q_type: 'self', text: "연인에게 '사랑받고 있다'고 가장 크게 느끼는 순간은?", type: "select", options: [{ value: "a", text: "사람들 앞에서 나를 자랑스럽게 칭찬해줄 때 (인정하는 말)" }, { value: "b", text: "힘들 때 말없이 꽉 안아줄 때 (스킨십)" }, { value: "c", text: "나와의 약속을 최우선으로 생각하고 시간을 내어줄 때 (함께하는 시간)" }, { value: "d", text: "내가 힘든 일을 묵묵히 대신 처리해줄 때 (봉사)" }, { value: "e", text: "내 취향을 기억하고 깜짝 선물을 해줄 때 (선물)" }] },
            { id: 'q_m3_self', part: "Part 4: 관계의 기술 (소통/관계)", for_gender: 'male', q_type: 'self', text: "힘든 일이 있을 때, 연인에게 어느 정도까지 솔직하게 털어놓나요?", type: "select", options: [{ value: "a", text: "사소한 것까지 모두 공유하며 위로받고 싶다" }, { value: "b", text: "걱정시킬까 봐, 심각한 문제는 혼자 해결하려 한다" }, { value: "c", text: "대부분 혼자 해결하지만, 정말 힘들 땐 기댄다" }] },
            { id: 'q_m3_exp', part: "Part 4: 관계의 기술 (소통/관계)", for_gender: 'female', q_type: 'expectation', text: "파트너가 힘든 일을 겪을 때, 당신에게 어떻게 해주길 바라나요?", type: "select", options: [{ value: "a", text: "사소한 것까지 모두 공유하며 위로받고 싶다" }, { value: "b", text: "걱정시킬까 봐, 심각한 문제는 혼자 해결하려 한다" }, { value: "c", text: "대부분 혼자 해결하지만, 정말 힘들 땐 기댄다" }] },
            { id: 'q_f3_self', part: "Part 4: 관계의 기술 (소통/관계)", for_gender: 'female', q_type: 'self', text: "연인에게 '보호받고 있다'고 느끼게 하는 가장 중요한 행동은 무엇인가요?", type: "select", options: [{ value: "a", text: "밤늦게 귀가할 때 데리러 와주는 등 물리적인 보호" }, { value: "b", text: "다른 사람 앞에서 내 편을 들어주는 등 사회적인 보호" }, { value: "c", text: "내 감정을 세심하게 살피고 공감해주는 정서적인 보호" }] },
            { id: 'q_f3_exp', part: "Part 4: 관계의 기술 (소통/관계)", for_gender: 'male', q_type: 'expectation', text: "파트너가 '보호받고 있다'고 느끼게 하기 위해 어떤 행동이 가장 중요하다고 생각하나요?", type: "select", options: [{ value: "a", text: "밤늦게 귀가할 때 데리러 와주는 등 물리적인 보호" }, { value: "b", text: "다른 사람 앞에서 내 편을 들어주는 등 사회적인 보호" }, { value: "c", text: "내 감정을 세심하게 살피고 공감해주는 정서적인 보호" }] },
        ];

        const partInfo = {
            "Part 1: 삶의 나침반 (가치관)": { title: "가치관 궁합", icon: "🧭", color: "green" },
            "Part 2: 타고난 다름 (성격/기질)": { title: "성격 궁합", icon: "🎭", color: "purple" },
            "Part 3: 일상의 합 (라이프스타일)": { title: "라이프스타일 궁합", icon: "🏡", color: "yellow" },
            "Part 4: 관계의 기술 (소통/관계)": { title: "소통 방식 궁합", icon: "❤️", color: "red" }
        };

        // --- UI Rendering Functions ---
        function renderQuestions() {
            const maleForm = document.getElementById('male-form');
            const femaleForm = document.getElementById('female-form');
            maleForm.innerHTML = '';
            femaleForm.innerHTML = '';
            let currentPartMale = "";
            let currentPartFemale = "";

            questions.forEach(q => {
                // Male Form
                if (!q.for_gender || q.for_gender === 'male') {
                    if (q.part !== currentPartMale) {
                        currentPartMale = q.part;
                        maleForm.innerHTML += `<h3 class="text-xl font-semibold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">${partInfo[currentPartMale].icon} ${currentPartMale}</h3>`;
                    }
                    maleForm.innerHTML += createQuestionHTML(q, 'male');
                }
                
                // Female Form
                if (!q.for_gender || q.for_gender === 'female') {
                     if (q.part !== currentPartFemale) {
                        currentPartFemale = q.part;
                        femaleForm.innerHTML += `<h3 class="text-xl font-semibold text-pink-700 border-b-2 border-pink-200 pb-2 mb-4">${partInfo[currentPartFemale].icon} ${currentPartFemale}</h3>`;
                    }
                    femaleForm.innerHTML += createQuestionHTML(q, 'female');
                }
            });
        }
        
        function createQuestionHTML(q, gender) {
            const isExpectation = q.q_type === 'expectation';
            const specificClass = isExpectation ? 'expectation-q' : 'self-q';
            const specificTag = isExpectation ? `<span class="text-xs font-bold text-white bg-teal-500 px-2 py-1 rounded-full ml-2">상대에게 기대</span>` : `<span class="text-xs font-bold text-white bg-indigo-500 px-2 py-1 rounded-full ml-2">나의 생각</span>`;

            return `
                <div class="question-card p-4 rounded-lg shadow ${specificClass}">
                    <label for="${q.id}-${gender}" class="block text-base font-medium text-gray-700 mb-3">${q.text} ${specificTag}</label>
                    ${q.type === 'select' ? createSelect(q, gender) : createRange(q, gender)}
                </div>`;
        }


        function createSelect(q, gender) {
            const optionsHTML = q.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
            return `<select id="${q.id}-${gender}" name="${q.id}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        ${optionsHTML}
                    </select>`;
        }

        // --- Matching Algorithm Logic (v9: Integrated) ---
        const matchups = [
            // Type 1: 나의 생각 vs 상대의 생각 (Self vs Self)
            { type: 'SvsS', male_q: 'q_child_plan_self', female_q: 'q_child_plan_self', part: "Part 1: 삶의 나침반 (가치관)" },
            { type: 'SvsS', male_q: 'q7_self', female_q: 'q7_self', part: "Part 3: 일상의 합 (라이프스타일)" },
            { type: 'SvsS', male_q: 'q_dessert_self', female_q: 'q_dessert_self', part: "Part 3: 일상의 합 (라이프스타일)" },
            { type: 'SvsS', male_q: 'q10_self', female_q: 'q10_self', part: "Part 4: 관계의 기술 (소통/관계)" },

            // Type 2: 나의 생각 vs 상대의 기대 (Self vs Expectation)
            { type: 'SvsE', self: 'q1_self', exp: 'q1_exp', self_gender: 'male', exp_gender: 'female', part: "Part 1: 삶의 나침반 (가치관)" },
            { type: 'SvsE', self: 'q1_self', exp: 'q1_exp', self_gender: 'female', exp_gender: 'male', part: "Part 1: 삶의 나침반 (가치관)" },
            { type: 'SvsE', self: 'q_m1_self', exp: 'q_m1_exp', self_gender: 'male', exp_gender: 'female', part: "Part 1: 삶의 나침반 (가치관)" },
            { type: 'SvsE', self: 'q_f1_self', exp: 'q_f1_exp', self_gender: 'female', exp_gender: 'male', part: "Part 1: 삶의 나침반 (가치관)" },
            { type: 'SvsE', self: 'q5_self', exp: 'q5_exp', self_gender: 'male', exp_gender: 'female', part: "Part 2: 타고난 다름 (성격/기질)" },
            { type: 'SvsE', self: 'q5_self', exp: 'q5_exp', self_gender: 'female', exp_gender: 'male', part: "Part 2: 타고난 다름 (성격/기질)" },
            { type: 'SvsE', self: 'q_m2_self', exp: 'q_m2_exp', self_gender: 'male', exp_gender: 'female', part: "Part 3: 일상의 합 (라이프스타일)" },
            { type: 'SvsE', self: 'q_f2_self', exp: 'q_f2_exp', self_gender: 'female', exp_gender: 'male', part: "Part 3: 일상의 합 (라이프스타일)" },
            { type: 'SvsE', self: 'q_m3_self', exp: 'q_m3_exp', self_gender: 'male', exp_gender: 'female', part: "Part 4: 관계의 기술 (소통/관계)" },
            { type: 'SvsE', self: 'q_f3_self', exp: 'q_f3_exp', self_gender: 'female', exp_gender: 'male', part: "Part 4: 관계의 기술 (소통/관계)" },
        ];

        function calculateResults() {
            const maleAnswers = getAnswers('male');
            const femaleAnswers = getAnswers('female');
            
            const results = {};
            let allScores = [];

            for (const part in partInfo) {
                const partMatchups = matchups.filter(m => m.part === part);
                if (partMatchups.length === 0) continue;

                const partScores = partMatchups.map(m => {
                    let answer1, answer2;
                    if (m.type === 'SvsS') {
                        answer1 = maleAnswers[m.male_q];
                        answer2 = femaleAnswers[m.female_q];
                    } else { // SvsE
                        answer1 = (m.self_gender === 'male') ? maleAnswers[m.self] : femaleAnswers[m.self];
                        answer2 = (m.exp_gender === 'male') ? maleAnswers[m.exp] : femaleAnswers[m.exp];
                    }
                    const question = questions.find(q => q.id === (m.male_q || m.self));
                    return calculateScore(question, answer1, answer2);
                });
                
                const averageScore = partScores.reduce((a, b) => a + b, 0) / partScores.length;
                results[part] = {
                    score: Math.round(averageScore),
                    comment: getComment(part, Math.round(averageScore))
                };
                allScores.push(...partScores);
            }
            
            const overallAverage = allScores.reduce((a, b) => a + b, 0) / allScores.length;
            results.overall = {
                score: Math.round(overallAverage),
                comment: getOverallComment(Math.round(overallAverage))
            };

            displayResults(results, maleAnswers, femaleAnswers);
        }

        function getAnswers(gender) {
            const form = document.getElementById(`${gender}-form`);
            const formData = new FormData(form);
            const answers = {};
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            return answers;
        }

        function calculateScore(question, answer1, answer2) {
            if (!question || !answer1 || !answer2) return 50; // 기본 점수
            if (question.id === 'q_child_plan_self') {
                const scoreMap = { 'a': 1, 'b': 2, 'c': 4, 'd': 3 };
                const diff = Math.abs(scoreMap[answer1] - scoreMap[answer2]);
                return Math.max(0, 100 - diff * 33);
            }
            if (question.type === 'select') {
                return answer1 === answer2 ? 100 : 0;
            }
            return 50;
        }

        // --- Result Generation and Display ---
        function getComment(part, score) {
            if (score >= 80) return "아주 잘 맞아요! 두 분은 서로를 잘 이해하고 기대를 채워주는 멋진 파트너가 될 수 있습니다.";
            if (score >= 60) return "잘 맞는 편이에요. 대부분의 경우 서로를 만족시키지만, 약간의 생각과 기대치 차이가 존재합니다.";
            if (score >= 40) return "생각이나 기대치가 다른 부분이 있네요. 이 차이점에 대해 이야기 나누며 서로를 이해하는 노력이 필요합니다.";
            return "상당한 생각과 기대치 차이가 발견되었어요. 이 부분은 관계에서 오해의 소지가 될 수 있으니, 깊은 대화가 꼭 필요해 보입니다.";
        }
        
        function getOverallComment(score) {
            if (score >= 85) return "환상의 커플! 서로의 생각과 기대를 완벽하게 채워주는, 천생연분입니다!";
            if (score >= 70) return "멋진 조합이에요! 서로의 마음을 잘 알아주고 맞춰주며 함께 성장할 수 있는 관계입니다.";
            if (score >= 50) return "알아가는 재미가 있겠어요! 서로의 생각과 기대치를 알아가며 맞춰가는 과정이 즐거울 거예요.";
            return "도전적인 관계가 될 수 있어요! 서로의 생각과 기대가 다른 부분이 많지만, 대화를 통해 충분히 극복하고 더 깊어질 수 있습니다.";
        }

        function displayResults(results, maleAnswers, femaleAnswers) {
            document.getElementById('overall-score').textContent = `${results.overall.score}점`;
            document.getElementById('overall-comment').textContent = results.overall.comment;

            const container = document.getElementById('detailed-results-container');
            container.innerHTML = '';
            for (const part in partInfo) {
                if(results[part]){
                    const info = partInfo[part];
                    const result = results[part];
                    container.innerHTML += createResultCard(info, result);
                }
            }
            
            for (const part in partInfo) {
                if(results[part]){
                    const info = partInfo[part];
                    const result = results[part];
                    const progressBar = document.querySelector(`#bar-${info.color}`);
                    setTimeout(() => {
                        if(progressBar) progressBar.style.width = `${result.score}%`;
                    }, 100);
                }
            }
            
            document.getElementById('ice-breaking-questions').innerHTML = generateIceBreakers(maleAnswers, femaleAnswers);

            document.getElementById('result-modal').classList.remove('hidden');
            document.getElementById('result-modal').classList.add('flex');
            setTimeout(() => {
                document.getElementById('result-content').classList.remove('scale-95');
                document.getElementById('result-content').classList.add('scale-100');
            }, 50);
        }
        
        function createResultCard(info, result) {
            const colorClasses = {
                green: { bg: 'bg-green-100', border: 'border-green-300', bar: 'bg-green-500', text: 'text-green-800' },
                purple: { bg: 'bg-purple-100', border: 'border-purple-300', bar: 'bg-purple-500', text: 'text-purple-800' },
                yellow: { bg: 'bg-yellow-100', border: 'border-yellow-300', bar: 'bg-yellow-500', text: 'text-yellow-800' },
                red: { bg: 'bg-red-100', border: 'border-red-300', bar: 'bg-red-500', text: 'text-red-800' },
            };
            const c = colorClasses[info.color];

            return `
                <div class="${c.bg} ${c.border} border-l-4 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold ${c.text}">${info.icon} ${info.title}</h3>
                        <span class="font-bold text-xl ${c.text}">${result.score}점</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="bar-${info.color}" class="result-bar ${c.bar} h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                    <p class="mt-2 text-sm ${c.text}">${result.comment}</p>
                </div>
            `;
        }
        
        // --- Icebreaker Generation Logic (v9: Integrated) ---
        function generateIceBreakers(maleAnswers, femaleAnswers) {
            let suggestions = [];

            const getAnswerText = (qId, answerValue) => {
                const question = questions.find(q => q.id === qId);
                if (!question || !answerValue) return '"[응답 없음]"';
                const option = question.options.find(o => o.value === answerValue);
                return option ? `"${option.text}"` : answerValue;
            };

            // 1. 남성의 실제 성향 vs 여성의 기대
            const male_self_m1 = getAnswerText('q_m1_self', maleAnswers.q_m1_self);
            const female_exp_m1 = getAnswerText('q_m1_exp', femaleAnswers.q_m1_exp);
            if (maleAnswers.q_m1_self === femaleAnswers.q_m1_exp) {
                suggestions.push({
                    title: "👩‍🦰❤️👨‍🦱 기대와 현실의 일치!",
                    text: `'파트너의 소득/직업에 대한 불안감'에 대해, 남성분은 실제로 ${male_self_m1}(이)라고 행동하고, 여성분은 파트너가 그렇게 해주길 바랐어요. 서로의 기대를 완벽하게 채워주는, 정말 잘 맞는 커플이네요!`
                });
            } else {
                suggestions.push({
                    title: "👩‍🦰↔️👨‍🦱 서로의 마음 알아보기",
                    text: `'파트너의 소득/직업에 대한 불안감'에 대해, 남성분은 ${male_self_m1}(이)라고 답했지만, 여성분은 ${female_exp_m1}(이)라고 해주길 바랐어요. 이 생각의 차이에 대해 이야기 나눠보면 서로를 더 깊이 이해할 수 있을 거예요.`
                });
            }

            // 2. 여성의 실제 성향 vs 남성의 기대
            const female_self_f1 = getAnswerText('q_f1_self', femaleAnswers.q_f1_self);
            const male_exp_f1 = getAnswerText('q_f1_exp', maleAnswers.q_f1_exp);
            if (femaleAnswers.q_f1_self === maleAnswers.q_f1_exp) {
                suggestions.push({
                    title: "👨‍🦱❤️👩‍🦰 완벽한 하모니!",
                    text: `'커리어 중단 가능성'에 대해, 여성분은 실제로 ${female_self_f1}(이)라고 생각하고, 남성분은 파트너가 그렇게 생각해주길 바랐어요. 미래를 그리는 가치관이 일치하여 안정적인 관계를 만들어갈 수 있겠어요.`
                });
            } else {
                suggestions.push({
                    title: "👨‍🦱↔️👩‍🦰 존중과 이해의 시간",
                    text: `'커리어 중단 가능성'에 대해, 여성분은 ${female_self_f1}(이)라고 답했지만, 남성분은 ${male_exp_f1}(이)라고 생각해주길 바랐어요. 각자의 커리어와 삶의 목표에 대해 진솔한 대화를 나누며 서로를 응원해주세요.`
                });
            }

            // 3. 자녀 계획 (나의 생각 vs 나의 생각)
            const male_child_plan = getAnswerText('q_child_plan_self', maleAnswers.q_child_plan_self);
            const female_child_plan = getAnswerText('q_child_plan_self', femaleAnswers.q_child_plan_self);
            if(maleAnswers.q_child_plan_self !== femaleAnswers.q_child_plan_self) {
                 suggestions.push({
                    title: "🧭 미래를 함께 그리다",
                    text: `자녀 계획에 대해 남성분은 ${male_child_plan}, 여성분은 ${female_child_plan}(이)라고 답했어요. 이 주제는 관계에서 매우 중요하므로, 두 분이 생각하는 이상적인 가족의 모습과 미래에 대해 솔직한 대화를 나눠보는 것이 중요해요.`
                });
            }


            return suggestions.map(s => `
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 text-lg mb-2">${s.title}</h4>
                    <p class="text-gray-600 text-base">${s.text}</p>
                </div>
            `).join('');
        }

        // --- Event Listeners ---
        document.getElementById('view-result-btn').addEventListener('click', calculateResults);
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            document.getElementById('result-content').classList.add('scale-95');
            document.getElementById('result-content').classList.remove('scale-100');
            setTimeout(() => {
                document.getElementById('result-modal').classList.add('hidden');
                document.getElementById('result-modal').classList.remove('flex');
            }, 300);
        });

        // Initial Render
        window.onload = renderQuestions;
    </script>
</body>
</html>
